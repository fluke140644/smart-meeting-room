document.addEventListener('DOMContentLoaded', async function () {
    const calendarEl = document.getElementById('calendar');

    try {
      // โหลดวันหยุดจากไฟล์ JSON
      const holidayRes = await fetch("{% static 'holidays.json' %}");
      const holidayJson = await holidayRes.json();
      const holidayItems = holidayJson.items || [];

      const holidayEvents = holidayItems.map(h => ({
        title: h.summary,
        start: h.start.date,
        allDay: true,
        isHoliday: true,
        display: 'list-item',
        textColor: '#ff0000'
      }));

      // โหลด event ห้องประชุมจาก backend
      const roomRes = await fetch('/calendar/events/');
      const roomJson = await roomRes.json();

      const allEvents = [...roomJson, ...holidayEvents];
      const isMobile = window.innerWidth < 768;

      // สร้างปฏิทิน
      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: isMobile ? 'listWeek' : 'dayGridMonth',
        aspectRatio: isMobile ? 0.75 : 1.5,
        height: isMobile ? 'auto' : 600,
        initialView: 'dayGridMonth',
        locale: 'th',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: isMobile ? '' : 'dayGridMonth,timeGridWeek,listWeek'
        },
        events: allEvents,

        eventDidMount: function (info) {
          if (info.event.extendedProps.isHoliday) {
            info.el.innerHTML = `<div class="fc-holiday-label">${info.event.title}</div>`;
          }
        },

        eventContent: function (arg) {
          const start = new Date(arg.event.start);
          const end = new Date(arg.event.end);
          const startTime = start.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
          const endTime = end ? end.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }) : '-';
          const timeRange = `${startTime} - ${endTime}`;
          const title = arg.event.title;
          const room = arg.event.extendedProps.room || '';

          let roomColor = '#0033FF';
          if (room === 'ห้องประชุมเพรชสมเด็จ') roomColor = '#0033FF';
          else if (room === 'ห้องประชุมผาเสวย') roomColor = '#228B22';
          else if (room === 'ห้องประชุมย่อย(วัคซีน 1)') roomColor = '#A020F0';
          else if (room === 'ห้องประชุมภูเงิน') roomColor = '#FF1493';

          return {
            html: `<div style="
    font-size: 0.6rem;
    word-break: break-word;
    white-space: normal;
    line-height: 1.2;
    max-width: 100%;
  " class="text-sm break-words leading-tight"><strong>${timeRange} ${title}</strong><br><span style="color: ${roomColor}; font-size: 0.8rem;">(${room})</span></div>`
          };
        },

        eventClick: function (info) {
          const start = info.event.start;
          const end = info.event.end;
          const event = info.event.extendedProps;

          if (event.room) {
            Swal.fire({
              title: `<strong>${info.event.title}</strong>`,
              html: `
                <p><b>ห้องประชุม :</b> ${event.room}</p>
                <p><b>รายละเอียด :</b> ${event.description}</p>
                <p><b>เวลาเริ่ม :</b> ${start.toLocaleString('th-TH')}</p>
                <p><b>เวลาสิ้นสุด :</b> ${end ? end.toLocaleString('th-TH') : '-'}</p>
                <p><b>แผนก :</b> ${event.department}</p>
                <p><b>จำนวนผู้เข้าประชุม :</b> ${event.attendees}</p>
                <p><b>ผู้ขอใช้ :</b> ${event.requester}</p>
                <p><b>เบอร์โทร :</b> ${event.phone}</p>
              `,
              icon: 'info',
              confirmButtonText: 'ปิด',
              customClass: {
                popup: 'rounded-xl shadow-xl p-4',
                title: 'text-left',
                content: 'text-left',
                confirmButton: 'btn-red'
              }
            });
          }
        }
      });

      calendar.render();

    } catch (error) {
      console.error("เกิดข้อผิดพลาดในการโหลดข้อมูล:", error);
    }
  });